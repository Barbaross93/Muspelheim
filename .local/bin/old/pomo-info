#!/usr/bin/bash

# For state: 1 equals active, 0 is paused
state=$(pomod info 2>/dev/null | cut -d ';' -f2)

# For phase: 0 is pomodoro, 1 is short break, 2 is long break
phase=$(pomod info 2>/dev/null | cut -d ';' -f1)

time_left=$(pomod info 2>/dev/null | cut -d ';' -f4)
time_left=$(date -d@$time_left -u +%M:%S)

num='^[0-9]+$'

start_or_resume() {
	if ! [[ $state =~ $num ]]; then
		pomod -a "aplay ~/.config/pomod/sound.ogg" start
	else
		pomod start
	fi
}

halt() {
	if [[ "$phase" == 0 ]]; then
		current="pomodoro"
	elif [[ "$phase" == "1" ]]; then
		current="small break"
	elif [[ "$phase" == 2 ]]; then
		current="long break"
	fi
	time_formatted=$(date -d@$time_left -u +%M:%S)
	pomod halt && notify-send -u normal "pomod" "Halted. Current phase is $current with $time_formatted remaining"
}

main() {
	if ! [[ $state =~ $num ]]; then
		notify-send "pomod" "<span foreground='#878787'></span> Currently not running"
	else
		if [[ $state -eq 1 ]] && [[ $phase -eq 0 ]]; then
			notify-send "pomod" "<span foreground='#af5f5f'></span> Active Pomodoro: $time_left remaining"
		elif [[ $state -eq 0 ]] && [[ $phase -eq 0 ]]; then
			notify-send "pomod" "<span foreground='#878787'></span> Paused Pomodoro: $time_left remaining"
		elif [[ $state -eq 1 ]] && [[ $phase -eq 1 ]]; then
			notify-send "pomod" "<span foreground='#87afaf'></span> Active Short Break: $time_left remaining"
		elif [[ $state -eq 0 ]] && [[ $phase -eq 1 ]]; then
			notify-send "pomod" "<span foreground='#878787'></span> Paused Short Break: $time_left remaining"
		elif [[ $state -eq 1 ]] && [[ $phase -eq 2 ]]; then
			notify-send "pomod" "<span foreground='#5787af'></span> Active Long Break: $time_left remaining"
		elif [[ $state -eq 0 ]] && [[ $phase -eq 2 ]]; then
			notify-send "pomod" "<span foreground='#878787'></span> Paused Long Break: $time_left remaining"
		fi
	fi
}

case "$1" in
--start | -s)
	start_or_resume
	;;
--pause | -p)
	halt
	;;
--info | -i | *)
	main
	;;
esac
